import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import Message
from aiogram.methods import DeleteWebhook
import aiohttp
import textwrap

BOT_TOKEN = "7996849165:AAH1tkZsYQxwLfOguBvOKhc1FjareBp9_Bg"
API_TOKEN = "io-v2-eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJvd25lciI6ImIxM2RhY2NiLTNkYWItNDQzZC05NTlmLTM3ZGQxMDZkYmJjZCIsImV4cCI6NDg5ODA2ODgwMH0.jbBDc3pcXGiIYts9KfRgrajHfqSm6m2nrmuJ4ABb1UmnVoMsPWIJwbniYCeyGp6pyOXyoEsh0cod3PZ9PVMdXw"
MAX_MESSAGE_LENGTH = 4096

PROMPT = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–∫—Å—Ç—É –Ω–∏–∂–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã: "–≠—Ç–æ –≤–Ω–µ –º–æ–µ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ." –î–∞–π —Ç–æ—á–Ω—ã–µ, –∫—Ä–∞—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã.
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ù–∞ –≤–æ–ø—Ä–æ—Å—ã "–ö–∞–∫ –Ω–∞—á–∞—Ç—å?" –∏–ª–∏ "–ö–∞–∫ —Å—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º?": "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: @yandexproeda."
- –ù–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ç–∞–≤–∫–∞—Ö: "–°—Ç–∞–≤–∫–∏ –¥–ª—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≥–æ—Ä–æ–¥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –õ–ö: https://partners-app.taxi.yandex.ru/tariffs."
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º ‚Äî –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤, —É–∫–∞–∑—ã–≤–∞–π –≥–æ—Ä–æ–¥, —Å—Ç–∞–≤–∫—É –∑–∞ –∑–∞–∫–∞–∑, –±–∞–∑–æ–≤—É—é —Å—Ç–∞–≤–∫—É, –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥, –ø–µ—Ä–∏–æ–¥ (14.04.2025‚Äì20.04.2025). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–≤–∫–∏ –≤ –ø–æ—Å—Ç–∞—Ö –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤.
- –î–∞—Ç—ã –≤—ã–ø–ª–∞—Ç: –∑–∞ –ø–µ—Ä–∏–æ–¥ 1‚Äì31, –¥–æ 20-–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ —Ñ–µ–≤—Ä–∞–ª—å ‚Äî –¥–æ 20 –º–∞—Ä—Ç–∞).
- –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω: –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π (—Å–æ—Ü—Å–µ—Ç–∏, job-—Å–∞–π—Ç—ã) –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ 18+, —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–∞–Ω–∞–ª–æ–≤ (–í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Telegram, hh.ru).
- –ü–æ—Å—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π: –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤, —É–∫–∞–∂–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–≥–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥, —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç—å), –≥–æ—Ä–æ–¥, —Å—Å—ã–ª–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, bit.ly/yandexproeda, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞). –ù–µ —É–ø–æ–º–∏–Ω–∞–π —Å—Ç–∞–≤–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–≤—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥". –ù–µ –≤–∫–ª—é—á–∞–π —à–∞–≥ —Å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–µ–π. –î–æ–±–∞–≤—å –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É: "–†–µ–∫–ª–∞–º–∞, erid".
- –û—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç—É: –æ–ø–∏—à–∏ —à–∞–≥–∏ –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ –ö–¶/—á–∞—Ç-–±–æ—Ç–µ, —Å–∞–º–æ–∑–∞–Ω—è—Ç–æ—Å—Ç—å, –ø–µ—Ä–≤—ã–π —Å–ª–æ—Ç, –∑–∞–∫–∞–∑—ã), –±–µ–∑ —Å—Å—ã–ª–æ–∫ –∏ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏.
–¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–≤–æ–∫ (14.04.2025‚Äì20.04.2025, —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤):
- –ú–æ—Å–∫–≤–∞: 250 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1250 ‚ÇΩ, –º–∞–∫—Å. 32500 ‚ÇΩ/–∫—É—Ä—å–µ—Ä.
- –°–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫: 300 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1500 ‚ÇΩ, –º–∞–∫—Å. 39000 ‚ÇΩ.
- –¢–≤–µ—Ä—å: 200 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1000 ‚ÇΩ, –º–∞–∫—Å. 26000 ‚ÇΩ.
- –í–ª–∞–¥–∏–º–∏—Ä: 150 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 750 ‚ÇΩ, –º–∞–∫—Å. 19500 ‚ÇΩ.
- –õ—é–±–µ—Ä—Ü—ã: 90 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 450 ‚ÇΩ, –º–∞–∫—Å. 11700 ‚ÇΩ.
- –•–∏–º–∫–∏, –ö—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫: 300 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1500 ‚ÇΩ, –º–∞–∫—Å. 39000 ‚ÇΩ.
- –ú—ã—Ç–∏—â–∏: 150 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 750 ‚ÇΩ, –º–∞–∫—Å. 19500 ‚ÇΩ.
- –ë–∞–ª–∞—à–∏—Ö–∞: 200 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1000 ‚ÇΩ, –º–∞–∫—Å. 26000 ‚ÇΩ.
- –ö–æ—Ä–æ–ª—ë–≤: 100 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 500 ‚ÇΩ, –º–∞–∫—Å. 13000 ‚ÇΩ.
- –û–¥–∏–Ω—Ü–æ–≤–æ: 250 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1250 ‚ÇΩ, –º–∞–∫—Å. 32500 ‚ÇΩ.
- –ü—É—à–∫–∏–Ω–æ: 160 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 800 ‚ÇΩ, –º–∞–∫—Å. 20800 ‚ÇΩ.
- –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –°–æ—á–∏: 200 ‚ÇΩ/–∑–∞–∫–∞–∑, –±–∞–∑–∞ 1000 ‚ÇΩ, –º–∞–∫—Å. 26000 ‚ÇΩ.
–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –∏–∑—É—á–∏ –õ–ö (—Ä–∞–∑–¥–µ–ª –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è).
- –í—ã–ø–ª–∞—Ç—ã: –∑–∞ —Ü–µ–ª–µ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, —Ä–∞–∑ –≤ –º–µ—Å—è—Ü (1‚Äì31, –¥–æ 20-–≥–æ), –Ω–∞ –∫–∞—Ä—Ç—É. –ü—Ä–æ–≤–µ—Ä—è–π —Å—Ç–∞—Ç—É—Å –≤ –õ–ö. –û—Å–ø–∞—Ä–∏–≤–∞–π, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞.
- –ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ:
  - –ò—Å—Ç–æ—á–Ω–∏–∫–∏: hh.ru, –ê–≤–∏—Ç–æ, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Telegram, –≤—É–∑—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
  - –ê—É–¥–∏—Ç–æ—Ä–∏—è: 18+, —É—á–∏—Ç—ã–≤–∞–π –∏–Ω—Ç–µ—Ä–µ—Å—ã.
  - –û–±—ä—è–≤–ª–µ–Ω–∏—è: –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤ ‚Äî –≥—Ä–∞—Ñ–∏–∫, –¥–æ—Ö–æ–¥ (–±–µ–∑ —Ü–∏—Ñ—Ä). –ù–µ—Ç –æ—Ç–∫–ª–∏–∫–∞ ‚Äî —Å–º–µ–Ω–∏ —Ç–µ–∫—Å—Ç/–∫–∞–Ω–∞–ª.
  - –ü—Ä–æ—Ü–µ—Å—Å: –Ω–∞–π–¥–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ‚Üí –æ—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –õ–ö ‚Üí –æ–ø–∏—à–∏ —à–∞–≥–∏ ‚Üí —Å–ª–µ–¥–∏ –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º ‚Üí –≤—ã–ø–ª–∞—Ç–∞.
  - –ü—É—à: –Ω–∞–ø–æ–º–∏–Ω–∞–π –æ —à–∞–≥–∞—Ö. –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ: 7 –¥–Ω–µ–π, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
- –ü—Ä–∞–≤–∏–ª–∞: —Å–æ–±–ª—é–¥–∞–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É (erid, ¬´–†–µ–∫–ª–∞–º–∞¬ª), –∏–∑–±–µ–≥–∞–π —Ñ—Ä–æ–¥–∞. –ù–∞—Ä—É—à–µ–Ω–∏–µ = —Ä–∞–∑—Ä—ã–≤ –¥–æ–≥–æ–≤–æ—Ä–∞.
- –í–æ–ø—Ä–æ—Å—ã:
  - "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω": –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π, –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π.
  - –°—Ç–∞—Ç—É—Å: –∂–¥–∏ —Å—É—Ç–∫–∏, –æ—Å–ø–∞—Ä–∏–≤–∞–π.
  - –û—Ç–∫–∞–∑ –≤ –ö–¶: –¥–∞–π –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
  - –õ–ö: –ª–æ–≥–∏–Ω –±–µ–∑ ¬´@yandex.ru¬ª, –∏–Ω–∞—á–µ ‚Äî –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É.
- –ö–∞–Ω–¥–∏–¥–∞—Ç—ã: –†–§ 18+ (¬´–ú–æ–π –Ω–∞–ª–æ–≥¬ª, –ö–¶/–±–æ—Ç), 16+ (—Å –∑–∞—è–≤–ª–µ–Ω–∏–µ–º), –Ω–µ –†–§ (–¥–æ–∫—É–º–µ–Ω—Ç—ã, –ö–¶).
- –†–µ—Å—É—Ä—Å—ã: –õ–ö, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (@yandexproeda), —á–∞—Ç-–±–æ—Ç: https://t.me/Eda_online_activation_bot.
–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ò–ò:
- –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –ø–æ —Ç–µ–∫—Å—Ç—É/—Ç–∞–±–ª–∏—Ü–µ.
- –ö—Ä–∞—Ç–∫–æ, —Å —ç–º–æ–¥–∑–∏ (‚úÖ, ‚ùì).
"""

logging.basicConfig(level=logging.INFO)
bot = Bot(BOT_TOKEN)
dp = Dispatcher()
sessions = {}

async def typing_animation(chat_id):
    await bot.send_chat_action(chat_id=chat_id, action="typing")
    await asyncio.sleep(1)

def split_message(text, max_length=MAX_MESSAGE_LENGTH):
    return textwrap.wrap(text, max_length, replace_whitespace=False)

@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    welcome_text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞! üöÄ\n"
        "–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–∏ –∫—É—Ä—å–µ—Ä–æ–≤, –≤—ã–ø–ª–∞—Ç–∞—Ö –∏ –ø—Ä–∞–≤–∏–ª–∞—Ö.\n"
        "‚ùì –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: *–ö–∞–∫ –ø—Ä–∏–≤–ª–µ—á—å –∫—É—Ä—å–µ—Ä–æ–≤?* –∏–ª–∏ *–ö–æ–≥–¥–∞ –º–Ω–µ –∑–∞–ø–ª–∞—Ç—è—Ç?*"
    )
    await message.answer(welcome_text, parse_mode="Markdown")
    sessions[message.chat.id] = PROMPT

@dp.message()
async def handle_message(message: Message):
    if message.text.startswith("/"):
        return

    chat_id = message.chat.id
    thinking_msg = await bot.send_sticker(chat_id, "CAACAgIAAxkBAAECmpln-pz5GKR-kKvD9qHpFPfTYfQxYAACIwADKA9qFCdRJeeMIKQGNgQ")
    await typing_animation(chat_id)

    if chat_id not in sessions:
        sessions[chat_id] = PROMPT

    url = "https://api.intelligence.io.solutions/api/v1/chat/completions"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {API_TOKEN}",
    }
    data = {
        "model": "deepseek-ai/DeepSeek-R1",
        "messages": [
            {"role": "system", "content": sessions[chat_id]},
            {"role": "user", "content": message.text}
        ],
    }

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(url, headers=headers, json=data) as response:
                await bot.delete_message(chat_id, thinking_msg.message_id)
                if response.status != 200:
                    error = await response.text()
                    await message.answer(f"‚ùå –û—à–∏–±–∫–∞ API: {error}")
                    return

                response_data = await response.json()
                if 'choices' in response_data:
                    bot_response = response_data['choices'][0]['message']['content']
                    if '</think>' in bot_response:
                        bot_response = bot_response.split('</think>')[-1].strip()

                    messages = split_message(bot_response)
                    for msg in messages:
                        await message.answer(msg, parse_mode="Markdown")
                        if len(messages) > 1:
                            await asyncio.sleep(0.5)
                else:
                    await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç API")
    except Exception as e:
        await bot.delete_message(chat_id, thinking_msg.message_id)
        await message.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")

async def main():
    await bot(DeleteWebhook(drop_pending_updates=True))
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
